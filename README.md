## 🚀 DiscordへのYouTube動画通知システム導入ガイド（GAS利用）

このガイドは、Google Apps Script（GAS）を利用して、特定のYouTubeチャンネルの新しい動画やライブ配信開始を自動で検知し、Discordサーバーへ通知を送るシステムの設定方法を詳述します。

-----

## 1\. 📂 GASプロジェクトの準備とファイル連携

### 1-1. ファイルのインポートと保存

システムは2つのGASプロジェクト（ファイル）に分けて作成し、**機能の分離と整理**を行います。

| ファイル名 | GASでの役割と内容 |
| :--- | :--- |
| **`通知チャンネル`** | **メイン処理**。ユーザー設定（Webhook, ID）、YouTube API実行、Discord投稿処理を記述。 |
| **`discordsystem`** | **補助機能（ライブラリ）**。通知時間の管理やデータの比較など、汎用的な処理を記述。 |

> 💡 **用語解説：Google Apps Script (GAS)**
> Googleが提供するクラウドベースのプログラミング環境で、JavaScriptをベースにしています。Googleサービス（YouTube, Driveなど）の連携や自動化が可能です。

### 1-2. ライブラリの設定と連携（重要）

\*\*`通知チャンネル`**ファイルから**`discordsystem`\*\*ファイルの機能を使えるように連携させます。

1.  \*\*`discordsystem`**プロジェクトを開き、左側メニューの**⚙️「プロジェクトの設定」**から**「スクリプト ID」\*\*をコピーします。
2.  \*\*`通知チャンネル`**プロジェクトを開き、左側メニューの**📚「ライブラリ」\*\*を開きます。
3.  コピーした\*\*「スクリプト ID」\*\*を貼り付けます。
4.  **「識別子」**（ライブラリの名前）は必ず\*\*`discordsystem`\*\*として保存します。

> 📌 **意図：ライブラリ連携**
> 連携により、`通知チャンネル`のコード内で `discordsystem.nowdata()` のように、もう一方のプロジェクトの関数を呼び出して利用できるようになります。

-----

## 2\. 🔗 各種URLとAPIの設定

### 2-1. Discord Webhook URLの取得

\*\*Webhook（ウェブフック）\*\*は、外部サービスがDiscordチャンネルへメッセージを送信するための専用URL（APIエンドポイント）です。

  * Discordサーバーの **「サーバー設定」** → **「連携サービス」** → **「ウェブフック」** から新規作成し、URLをコピーします。

> ⚠️ **注意点：Webhook URLの管理**
> Webhook URLを知っている人は誰でもそのチャンネルにメッセージを投稿できてしまいます。**外部に漏れないよう**厳重に管理してください。

### 2-2. `通知チャンネル`ファイルの編集

取得した情報（Webhook URL、YouTubeチャンネルID）を、\*\*`通知チャンネル`\*\*ファイル内の`postchannel`変数に設定します。

```javascript
// 通知チャンネル (15行目付近)
var postchannel = {
  webhooks: 'ここにコピーしたDiscord Webhook URLを貼り付けます', // webhookのURL
  icon : '', // 通知メッセージのアイコン画像URL (任意。不要なら空欄またはコメントアウト)
  channel: 'ここに通知したいYouTubeチャンネルのIDを貼り付けます' // youtubeチャンネルのID
}
```

### 2-3. YouTube Data API の有効化

YouTubeの情報を取得するために、Googleの\*\*YouTube Data API (v3)\*\*をGASプロジェクトで有効にします。

1.  \*\*`通知チャンネル`**ファイルを開き、左側メニューの**➕「サービス」\*\*の横にある「サービスを追加」をクリックします。
2.  **`YouTube Data API`** を選択し、バージョン\*\*`v3`**であることを確認して**「追加」\*\*をクリックします。

> 💡 **用語解説：API (Application Programming Interface)**
> ソフトウェア間で情報や機能をやり取りするための窓口です。YouTube Data APIは、プログラムから動画情報やチャンネル情報を安全に取得できるように Google が提供している窓口です。

-----

## 3\. 🆔 YouTubeチャンネルIDの調べ方

チャンネルIDは、YouTubeチャンネルを特定する固有の文字列です。

  * YouTubeチャンネルにアクセスし、**「チャンネルを共有」** → \*\*「チャンネルIDをコピー」\*\*で取得できます。

-----

## 4\. ✅ テスト実行と承認プロセス

システムが正しく設定されているか確認します。

### 4-1. テストモードへの変更

システムは通常、過去の通知時間と比較して新しい動画のみを通知します。テストのため、この時間比較を無視する**テストモード**に切り替えます。

\*\*`通知チャンネル`\*\*ファイルの該当箇所（42行目付近）を以下のように編集します。

```javascript
// 通知チャンネル (42行目付近)

// 本番環境 (通常はこちら: 0)
// if (discordsystem.nowdata(posttime) === 0){ 
// ...

// 実行テスト (テスト時のみ: 1 に変更して実行)
if (discordsystem.nowdata(posttime) === 1){ // <-- ここを1に変更して実行
    var url = `${youtubeurl}${data.id.videoId}`;
    // ...
```

### 4-2. 実行と承認（認証プロセス）

1.  コード上部の▶️\*\*「実行」\*\*ボタンをクリックします。
2.  **初回実行時**は、GASがAPIや外部サービスを利用するための\*\*承認（アクセス許可）\*\*が求められます。

> 💡 **認証プロセスの意図**
> これは、GASが「**あなたのGoogleアカウント名義でYouTube APIにアクセスする**」ことをGoogleに許可する手続きです。画面の指示（「実行の承認」→「アカウント選択」→「詳細」→「〜に移動」）に従い、アクセスを許可してください。

3.  実行後、Discordサーバーにテスト通知が届けば成功です。
4.  テスト後は、必ず設定を元に戻し、\*\*本番環境（`=== 0`）\*\*にしてください。

-----

## 5\. ⏰ 自動実行（トリガー）の設定とクォータ制限

システムを定期的に自動で実行するために**トリガー**を設定します。

### 5-1. トリガーの基本設定

1.  \*\*`通知チャンネル`**プロジェクトを開き、左側メニューの**⏰「トリガー」\*\*を開きます。
2.  \*\*「トリガーを追加」\*\*をクリックし、以下を設定して保存します。
      * **実行する関数:** `getvideoset`
      * **時間ベースのトリガーのタイプを選択:** **`分タイマー`**
      * **時間の間隔を選択（分）:** **`15分`**

### 5-2. GASの仕様解説：YouTube APIのクォータ制限

YouTube Data APIには、不正な利用やサーバーへの過負荷を防ぐため、1日あたり**10,000ユニット**のクォータ（利用制限）が設けられています。

| 処理内容 | 消費クォータ |
| :--- | :--- |
| 動画検索（`search.list`）1回 | **100ユニット** |

  * 10,000クォータ $\div$ 100クォータ/回 = 100回
  * 1日（1440分） $\div$ 100回 $\approx$ 14.4分/回

そのため、クォータを使い切らないよう、実行間隔は**15分**に設定するのが最も効率的です。

#### 🔹 発展的な使用方法：実行間隔の変更

| 間隔 | 効果 | メリット | デメリット/注意点 |
| :--- | :--- | :--- | :--- |
| **5分** | リアルタイム性向上 | 通知の遅延を最小限にできる。 | クォータ消費が3倍になり、**1日約5000ユニット**を消費するため、他のAPI利用と合わせるとクォータ切れリスクが高い。 |
| **30分/1時間** | クォータ節約 | 1日あたり**2400〜4800ユニット**に抑えられる。 | 通知の遅延が大きくなる。 |

-----

## 6\. ⚙️ プログラム内の設定変更と発展的な使用方法

### 6-1. 動画通知とライブ配信通知の切り替え

`getYoutubeData`関数の引数\*\*`eventType`\*\*を変更することで、通知の対象を切り替えることができます。

```javascript
// 通知チャンネル (29行目付近)
  // 変更前（動画の場合）
  var datas = await getYoutubeData(postchannel.channel,eventType="none"); 

  // 変更後（ライブ配信の場合） 🔴
  // var datas = await getYoutubeData(postchannel.channel,eventType="live"); 
```

| `eventType` | 対象 | 意図 |
| :--- | :--- | :--- |
| `"none"` | アップロードされた**動画** | 新規動画投稿時の通知 |
| `"live"` | **現在進行中のライブ配信** | ライブ配信開始時の通知 |

### 6-2. 発展：クォータ制限を回避した動画とライブの同時通知

通知したいチャンネルが多い場合や、動画とライブ配信の両方の通知を確実に行いたい場合は、**GASプロジェクト自体を分けてしまう**のが最も簡単かつ確実な方法です。

1.  **「動画通知用」プロジェクト**（`eventType="none"`）を作成し、15分タイマーを設定。
2.  **「ライブ通知用」プロジェクト**（`eventType="live"`）をコピー作成し、1時間タイマーを設定。

<!-- end list -->

  * **効果:** それぞれのプロジェクトで独立したクォータ消費（1日最大2400ユニット）となるため、合計でも5000ユニット弱の消費に抑えられ、クォータ切れのリスクが大幅に下がります。

